{% extends 'layouts/base.html' %}

{% block title %} Dashboard {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}
{% load static %}
<link rel="stylesheet" href="{% static 'main.css' %}">






{% block content %}

  <!-- Header -->
  <div class="header bg-primary pb-6">
    <div class="container-fluid">
      <div class="header-body">
        <nav class="navbar navbar-top navbar-expand navbar-dark bg-primary border-bottom">
          <div class="container-fluid">
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <!-- Search form -->
              <form class="navbar-search navbar-search-light form-inline mr-sm-3">
                {% csrf_token %}
                <div class="form-group mb-0">
                    <div class="input-group input-group-alternative input-group-merge">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input class="form-control" id="searchInput"  placeholder="Search" >
                    </div>
                </div>
                <button type="button" class="close" data-action="search-close" data-target="#navbar-search-main" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </form>
            
              <!-- Navbar links -->
              <ul class="navbar-nav align-items-center  ml-md-auto ">
                <li class="nav-item d-xl-none">
                  <!-- Sidenav toggler -->
                  <div class="pr-3 sidenav-toggler sidenav-toggler-dark" data-action="sidenav-pin" data-target="#sidenav-main">
                    <div class="sidenav-toggler-inner">
                      <i class="sidenav-toggler-line"></i>
                      <i class="sidenav-toggler-line"></i>
                      <i class="sidenav-toggler-line"></i>
                    </div>
                  </div>
                </li>
                <li class="nav-item d-sm-none">
                  <a class="nav-link" href="#" data-action="search-show" data-target="#navbar-search-main">
                    <i class="ni ni-zoom-split-in"></i>
                  </a>
                </li>
              
                <li class="nav-item dropdown">
                  <a class="nav-link" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="ni ni-ungroup"></i>
                  </a>
                  
                  <div class="dropdown-menu dropdown-menu-lg dropdown-menu-dark bg-default  dropdown-menu-right ">
                    <div class="row shortcuts px-4">
                      <a href="{% url 'liste_employes' %}" class="col-4 shortcut-item text-center">
                        <span class="shortcut-media avatar rounded-circle bg-gradient-red">
                          <i class="fas fa-users"></i>
                        </span>
                        <small>P.A.T</small>
                      </a>
                      <!-- <a href="{% url 'liste_enseignants' %}" class="col-4 shortcut-item text-center">
                        <span class="shortcut-media avatar rounded-circle bg-gradient-orange">
                          <i class="ni ni-hat-3"></i>
                        </span>
                        <small>MESupReS</small>
                      </a> -->
                    
                      <a href="{% url 'liste_conges' %}" class="col-4 shortcut-item text-center">
                        <span class="shortcut-media avatar rounded-circle bg-gradient-green">
                          <i class="ni ni-single-copy-04"></i>
                        </span>
                        <small>Conge</small>
                      </a>
                      <a href="{% url 'list_affectations' %}" class="col-4 shortcut-item text-center">
                        <span class="shortcut-media avatar rounded-circle bg-gradient-purple">
                          <i class="ni ni-briefcase-24 "></i>
                        </span>
                        <small>Affectation</small>
                      </a>
                      
                    </div>
                  </div>
                </li>
              </ul>
              <ul class="navbar-nav align-items-center  ml-auto ml-md-0 ">
                <li class="nav-item dropdown">
                  <a class="nav-link pr-0" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <div class="media align-items-center">
                      
                      <div class="media-body  ml-2  d-none d-lg-block">
                        <span class="mb-0 text-sm ">
                         
                          {{ request.user.username|upper }}
                        
                        </span>
                      </div>
                    </div>
                  </a>
                  <div class="dropdown-menu  dropdown-menu-right ">
                   
                    <div class="dropdown-divider"></div>
                    <!-- <a action="{% url 'logout' %}" class="dropdown-item" method="post">
                      {% csrf_token %}
                      <i class="fas fa-sign-out-alt"></i>
                      <span type="submit">Logout</span>

                      
                    
                    </a> -->

                    <form action="{% url 'logout' %}" method="post">
                      <div class="text-center">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary my-4">Deconnexion</button>
                      </div>
                  </form>
                  
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </nav>
       
        <div class="row align-items-center py-4">
          <div class="col-lg-6 col-7">
            <h6 class="h2 text-white d-inline-block mb-0">Acceuil</h6>
            <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
              <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                <li class="breadcrumb-item"><a href=""><i class="fas fa-home"></i></a></li>
                <li class="breadcrumb-item"><a href="#">Tableau de bord</a></li>
              </ol>
            </nav>
          </div>
        </div>

        <!-- Card stats -->
        <div class="row">

        
          <div class="col-xl-3 col-md-2">
            <div class="card card-stats">
              <a href="{% url 'liste_employes' %}">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <span class="h3 font-weight-bold mb-0">PERSONNEL</span>
                    </div>
                  
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gray text-white rounded-circle shadow">
                    <span class="h3 font-weight-bold mb-0">{{ nombre_employes }}</span>
                  </div>
                </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gray text-white rounded-circle shadow">
                    
                        <i class="fas fa-users"></i>
                        
                      </div>
                    </div>
                 
                  <p class="mt-3 mb-0 text-sm">
                    <span class="text-nowrap">Employés</span>
                  </p>
                </div>
              </div>
              </a>
            </div>
          </div>
         
          <!-- <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
              <a href="{% url 'liste_enseignants' %}">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <span class="h3 font-weight-bold mb-0">P.E.C</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gray text-white rounded-circle shadow">
                    <span class="h3 font-weight-bold mb-0">{{ nombre_enseignants }}</span>
                  </div>
                </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                        <i class="ni ni-hat-3"></i>
                      </div>
                    </div>
                
            
                  <p class="mt-3 mb-0 text-sm">
                    
                    <span class="text-nowrap">Personnel Enseignant Chercheur </span>
                  </p>
                </div>
              </div>
          </a>
        </div>
      </div> -->
          
          <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
              <a href="{% url 'list_affectations' %}">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <span class="h3 font-weight-bold mb-0">AFFECT</span>
                    </div>

                    <div class="col-auto">
                      <div class="icon icon-shape bg-gray text-white rounded-circle shadow">
                    <span class="font-weight-bold mb-0">{{ nombre_affectations }}</span>
                      </div>
                    </div>
                    
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                        <i class="ni ni-briefcase-24"></i>
                      </div>
                    </div>
                  
                  <p class="mt-3 mb-0 text-sm">
                    <span class="text-nowrap">Affectation</span>
                  </p>
                </div> 
              </div>
          </a>
        </div>
      </div>
        

      <div class="col-xl-3 col-md-6">
        <div class="card card-stats">
          <a href="{% url 'list_affectations' %}">
            <div class="card-body">
              <div class="row">
                <div class="col">
                  <span class="h3 font-weight-bold mb-0">PERMISSION</span>
                </div>

                <div class="col-auto">
                  <div class="icon icon-shape bg-gray text-white rounded-circle shadow">
                <span class="font-weight-bold mb-0">{{ nombre_affectations }}</span>
                  </div>
                </div>
                
                <div class="col-auto">
                  <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                    <i class="ni ni-briefcase-24"></i>
                  </div>
                </div>
              
              <p class="mt-3 mb-0 text-sm">
                <span class="text-nowrap">Gerer permission</span>
              </p>
            </div> 
          </div>
      </a>
    </div>
  </div>



          <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
              <a href="{% url 'liste_conges' %}">
                <div class="card-body">
                  <div class="row">

                    <div class="col">
                      <span class="h3 font-weight-bold mb-0">CONGE</span> 
                    </div>

                    <div class="col-auto">
                      <div class="icon icon-shape bg-gray text-white rounded-circle shadow">
                    <span class="font-weight-bold mb-0">{{ nombre_conges }}</span>
                      </div>
                    </div>
                    

                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                        <i class="ni ni-single-copy-04"></i>
                      </div>
                    </div>
                      <p class="mt-3 mb-0 text-sm">
                      <span class="text-nowrap">gestion des conges</span>
                      </p>
                      </div>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>
         </div>
        </div>
   

        
        
        <div class="container-fluid mt--5">
          <div class="row">
            <div class="col-xl-6">
              <div class="card bg-default">
                  <div class="card-header bg-transparent">
                      <div class="row align-items-center">
                       
                        <div class="col">
                          <h6 class="text-uppercase text-muted ls-1 mb-1">répartition des effectifs par Departement des Employes</h6>
                          <h5 class="h3 mb-0"></h5>
                      </div>
                      </div>
                  </div>
                  <div class="card-body">
                    <div class="chart">
                      <canvas id="chart-employe-dept"></canvas>
                  </div>
                  </div>

                  

              </div>
          </div>
          

          
              <div class="col-xl-3">
                  <div class="card">
                      <div class="card-header bg-transparent">
                          <div class="row align-items-center">
                              <div class="col">
                                  <h6 class="text-uppercase text-muted ls-1 mb-1">répartition des effectifs</h6>
                                  <h5 class="h3 mb-0">Employes</h5>
                              </div>
                          </div>
                      </div>
                      <div class="card-body">
                          <!-- Chart -->
                          <div class="chart">
                              <canvas id="myChart"></canvas>
                          </div>
                      </div>
                  </div>
              </div>
<div class="col-xl-3">
            <div class="card ">
                <div class="card-header bg-transparent">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="text-uppercase text-muted ls-1 mb-1">effectifs par sexe</h6>
                            <h5 class="h3 mb-0">Employes</h5>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                  <div class="chart">
                    <canvas id="chart-employe-sex" width="100" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>


          </div>
      
          
    


          <div class="row">
         

                  
 <div class="col-xl-12">
  <div class="card">
      <div class="card-header bg-transparent">
              <div class="row align-items-center">
                  <div class="col">
                      <h6 class="text-uppercase text-muted ls-1 mb-1">répartition des Ages des Employes</h6>
                      <h5 class="h3 mb-0"></h5>
                  </div>
              </div>
          </div>
              <div class="card-body">
                <div class="chart">
                  <canvas id="chart-employe-age" width="50" height="50"></canvas>
              </div>
              </div>
          </div>
        </div>
</div>
 
  




</div>
{% endblock content %}


{% block javascripts %}

<script src="/static/assets/vendor/chart.js/dist/Chart.min.js"></script>
<script src="/static/assets/vendor/chart.js/dist/Chart.extension.js"></script>
<script src="/static/assets/vendor/charts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
  var ctx = document.getElementById("myChart");
var myChart = new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ["Employés"],
    datasets: [{
      data: [{{ nombre_enseignants }}, {{ nombre_employes }}],
      backgroundColor: ['#1cc88a'],
      hoverBackgroundColor: ['#2e59d9', '#17a673'],
      hoverBorderColor: "rgba(234, 236, 1)",
    }],
  },
  options: {
    maintainAspectRatio: false,
    cutoutPercentage: 0, // Modifier cette valeur pour changer la taille du trou central
    plugins: {
      tooltip: {
        callbacks: {
          label: function(context) {
            var label = context.label || '';
            if (label) {
              var dataset = context.dataset;
              var total = dataset.data.reduce(function(previousValue, currentValue) {
                return previousValue + currentValue;
              });
              var currentValue = dataset.data[context.dataIndex];
              var percentage = Math.round((currentValue / total) * 100);
              return label + ': ' + percentage + '%';
            }
            return '';
          }
        }
      }
    },
  }
});


  var getAgeDataURL = "{% url 'get_age_data' %}";
  var getDeptDataURL = "{% url 'get_dept_data' %}";


 

  function fetchAgeData() {
    $.ajax({
      url: getAgeDataURL,
      success: function(data) {
        drawAgeChart(data);
      }
    });
  }

  function fetchDeptData() {
    $.ajax({
      url: getDeptDataURL,
      success: function(data) {
        drawDeptChart(data);
      }
    });
  }

  $(document).ready(function() {
   
    fetchAgeData();
    fetchDeptData();
  });




  function drawAgeChart(ageData) {
    var ctx = document.getElementById('chart-employe-age').getContext('2d');
    var ageChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['18-25', '26-35', '36-45', '46+'],
            datasets: [{
                label: 'Âge moyen des employés',
                data: ageData,
                backgroundColor: ['#4e73df', '#2e59d9', '#1cc88a', '#36b9cc'],
                hoverBackgroundColor: ['#2e59d9', '#25558c', '#149b7f', '#2c9faf'],
                borderWidth: 2
            }]
        },
        options: {
            maintainAspectRatio: false,
            cutoutPercentage: 80,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            indexAxis: 'y'
        }
    });
  }

  function drawDeptChart(deptData) {
    var ctx = document.getElementById('chart-employe-dept').getContext('2d');
    var deptChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(deptData),
            datasets: [{
                data: Object.values(deptData),
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc'],
                hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf'],
                hoverBorderColor: 'rgba(234, 236, 1)'
            }]
        },
        options: {
            maintainAspectRatio: false,
            tooltips: {
                backgroundColor: 'rgb(255,255)',
                bodyFontColor: '#858796',
                borderColor: '#dddfeb',
                borderWidth: 1,
                xPadding: 15,
                yPadding: 15,
                displayColors: false,
                caretPadding: 80
            },
            legend: {
                display: true
            },
            cutoutPercentage: 100
        }
    });
  }

</script>
<script>
  var getSexDataURL = "{% url 'get_sex_data' %}";

  $(document).ready(function() {
    fetchSexData();
  });

  function fetchSexData() {
    $.ajax({
      url: getSexDataURL,
      success: function(data) {
        drawSexChart(data);
      }
    });
  }

  function drawSexChart(sexData) {
    var ctx = document.getElementById('chart-employe-sex').getContext('2d');
    var sexChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Hommes PAT', 'Femmes PAT'],
        datasets: [{
          data: [sexData.hommes, sexData.femmes, sexData.homes, sexData.femes],
          backgroundColor: ['#4e73df', '#1cc88a'],
          hoverBackgroundColor: ['#2e59d9', '#17a673', '#2e5996', '#17a612'],
          hoverBorderColor: 'rgba(234, 236, 235, 237, 1)'
        }]
      },
      options: {
        maintainAspectRatio: false,
        tooltips: {
          backgroundColor: 'rgb(255,255, 255,255)',
          bodyFontColor: '#858796',
          borderColor: '#ffffff',
          borderWidth: 1,
          xPadding: 15,
          yPadding: 15,
          displayColors: true,
          caretPadding: 80
        },
        legend: {
          display: true
        }
      }
    });
  }
</script>


{% endblock javascripts %}
